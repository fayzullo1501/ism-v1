<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Администратор - Врачи</title>
    <link rel="stylesheet" href="../styles/dashboard-admin.css">
    <link rel="stylesheet" href="../styles/doctors.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="icon" href="/images/favicon.svg" type="image/png">
</head>
<body>
    <div class="container">
        <!-- Левая панель с меню -->
        <div class="sidebar">
            <div class="logo">
                <img src="/images/logo.png" alt="Клиника" class="logo-img">
            </div>
            <ul class="menu">
                <li><a href="dashboard-admin.html"><i class="fas fa-home"></i> Главная</a></li>
                <li><a href="patients.html"><i class="fas fa-user-injured"></i> Пациенты</a></li>
                <li><a href="services.html"><i class="fas fa-briefcase-medical"></i> Услуги</a></li>
                <li><a href="doctors.html" class="active"><i class="fas fa-user-md"></i> Врачи</a></li>
                <li><a href="wards.html"><i class="fas fa-hospital"></i> Палаты</a></li>
            </ul>
            <div class="logout">
                <a href="login.html"><i class="fas fa-sign-out-alt"></i> Выход</a>
            </div>
        </div>
    
        <!-- Правая панель (контент) -->
        <div class="main-content">
            <div class="module-header">
                <h1>Врачи</h1>
            </div>
            <div class="module-content">
                <!-- Кнопки действий и поиск -->
                <div class="actions">
                    <div class="action-buttons">
                        <button id="addDoctorBtn">Добавить</button>
                        <button id="deleteDoctorBtn" disabled>Удалить</button>
                        <button id="editDoctorBtn" disabled>Изменить</button>
                    </div>
                    <input type="text" id="searchInput" placeholder="Поиск" class="search-input">
                </div>
    
                <!-- Прокручиваемая таблица врачей -->
                <div class="table-wrapper">
                    <table class="doctors-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"></th>
                                <th>№</th>
                                <th>ФИО</th>
                                <th>Специальность</th>
                                <th>Комната</th>
                                <th>Паспорт</th>
                                <th>Телефон</th>
                                <th>Адрес</th>
                                <th>Дата регистрации</th>
                            </tr>
                        </thead>
                        <tbody id="doctorsTableBody"></tbody>
                    </table>
                </div>
                <div id="pagination" class="pagination-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для добавления врача -->
    <div class="overlay" id="overlay"></div>
    <div id="addDoctorModal" class="modal">
        <h2>Добавить нового врача</h2>
        <form id="addDoctorForm">
            <div class="form-row">
                <label for="doctorFullName">ФИО:</label>
                <input type="text" name="fullName" id="doctorFullName" placeholder="ФИО" required>
            </div>
            <div class="form-row">
                <label for="doctorSpecialty">Специальность:</label>
                <select id="doctorSpecialty" name="specialty" required>
                    <!-- Специальности будут добавлены динамически -->
                </select>
            </div>
            <div class="form-row">
                <label for="doctorRoom">Комната:</label>
                <input type="text" name="room" id="doctorRoom" placeholder="Номер комнаты" required>
            </div>
            <div class="form-row">
                <label for="doctorPassport">Паспорт:</label>
                <input type="text" name="passport" id="doctorPassport" placeholder="Паспортные данные" required>
            </div>
            <div class="form-row">
                <label for="doctorPhone">Телефон:</label>
                <input type="tel" name="phone" id="doctorPhone" placeholder="Телефон" required>
            </div>
            <div class="form-row">
                <label for="doctorAddress">Адрес:</label>
                <input type="text" name="address" id="doctorAddress" placeholder="Адрес" required>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-save">Сохранить</button>
                <button type="button" class="btn-cancel">Отменить</button>
            </div>
        </form>
    </div>

    <!-- Модальное окно для изменения врача -->
    <div id="editDoctorModal" class="modal">
        <h2>Изменить данные врача</h2>
        <form id="editDoctorForm">
            <input type="hidden" name="doctorId">
            <div class="form-row">
                <label for="editDoctorFullName">ФИО:</label>
                <input type="text" name="fullName" id="editDoctorFullName" placeholder="ФИО" required>
            </div>
            <div class="form-row">
                <label for="editDoctorSpecialty">Специальность:</label>
                <select id="editDoctorSpecialty" name="specialty" required></select>
            </div>
            <div class="form-row">
                <label for="editDoctorRoom">Комната:</label>
                <input type="text" name="room" id="editDoctorRoom" placeholder="Номер комнаты" required>
            </div>
            <div class="form-row">
                <label for="editDoctorPassport">Паспорт:</label>
                <input type="text" name="passport" id="editDoctorPassport" placeholder="Паспортные данные" required>
            </div>
            <div class="form-row">
                <label for="editDoctorPhone">Телефон:</label>
                <input type="tel" name="phone" id="editDoctorPhone" placeholder="Телефон" required>
            </div>
            <div class="form-row">
                <label for="editDoctorAddress">Адрес:</label>
                <input type="text" name="address" id="editDoctorAddress" placeholder="Адрес" required>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-save">Сохранить</button>
                <button type="button" class="btn-cancel">Отменить</button>
            </div>
        </form>
    </div>

    <script>
            document.addEventListener("DOMContentLoaded", () => {
        loadDoctors();
        loadSpecialties();

        document.getElementById('addDoctorBtn').addEventListener('click', function() {
            document.getElementById('addDoctorModal').classList.add('show');
            document.getElementById('overlay').classList.add('show');
        });

        document.getElementById('editDoctorBtn').addEventListener('click', function() {
            const selectedDoctorId = getSelectedDoctorId();
            if (selectedDoctorId) {
                fetch(`/doctors/${selectedDoctorId}`)
                    .then(response => response.json())
                    .then(doctor => {
                        document.getElementById('editDoctorForm').doctorId.value = doctor._id;
                        document.getElementById('editDoctorFullName').value = doctor.fullName;
                        document.getElementById('editDoctorSpecialty').value = doctor.specialty;
                        document.getElementById('editDoctorRoom').value = doctor.room;
                        document.getElementById('editDoctorPassport').value = doctor.passport;
                        document.getElementById('editDoctorPhone').value = doctor.phone;
                        document.getElementById('editDoctorAddress').value = doctor.address;
                        document.getElementById('editDoctorModal').classList.add('show');
                        document.getElementById('overlay').classList.add('show');
                    });
            }
        });

        document.getElementById('overlay').addEventListener('click', closeModal);
        document.querySelectorAll('.btn-cancel').forEach(button => button.addEventListener('click', closeModal));

        document.getElementById('addDoctorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/doctors/add', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(() => {
                alert('Врач успешно добавлен!');
                closeModal();
                loadDoctors();
            });
        });

        document.getElementById('editDoctorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(`/doctors/edit/${formData.get('doctorId')}`, {
                method: 'PUT',
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(() => {
                alert('Данные врача успешно обновлены!');
                closeModal();
                loadDoctors();
            });
        });

        document.getElementById('deleteDoctorBtn').addEventListener('click', function() {
            const selectedDoctorId = getSelectedDoctorId();
            if (selectedDoctorId && confirm('Вы действительно хотите удалить выбранного врача?')) {
                fetch(`/doctors/delete/${selectedDoctorId}`, { method: 'DELETE' })
                    .then(() => {
                        alert('Врач удалён');
                        loadDoctors();
                    });
            }
        });

        function loadDoctors() {
            fetch('/doctors/list')
                .then(response => response.json())
                .then(data => {
                    const doctorsTableBody = document.getElementById('doctorsTableBody');
                    doctorsTableBody.innerHTML = '';
                    data.forEach((doctor, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" data-doctor-id="${doctor._id}"></td>
                            <td>${index + 1}</td>
                            <td>${doctor.fullName}</td>
                            <td>${doctor.specialty}</td>
                            <td>${doctor.room}</td>
                            <td>${doctor.passport}</td>
                            <td>${doctor.phone}</td>
                            <td>${doctor.address}</td>
                            <td>${new Date(doctor.createdAt).toLocaleDateString()}</td>
                        `;
                        doctorsTableBody.appendChild(row);
                    });
                });
        }

        function loadSpecialties() {
            fetch('/services/list')
                .then(response => response.json())
                .then(services => {
                    const specialtySelect = document.getElementById('doctorSpecialty');
                    const editSpecialtySelect = document.getElementById('editDoctorSpecialty');
                    specialtySelect.innerHTML = ''; 
                    editSpecialtySelect.innerHTML = ''; 
                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.serviceName;
                        option.textContent = service.serviceName;
                        specialtySelect.appendChild(option.cloneNode(true));
                        editSpecialtySelect.appendChild(option);
                    });
                });
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
            document.getElementById('overlay').classList.remove('show');
        }

        function getSelectedDoctorId() {
            const selectedCheckbox = document.querySelector('#doctorsTableBody input[type="checkbox"]:checked');
            return selectedCheckbox ? selectedCheckbox.dataset.doctorId : null;
        }
    });
    </script>
</body>
</html>
